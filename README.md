[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Этот проект распространяется под лицензией MIT.  
Вы можете свободно использовать, модифицировать и распространять скрипт,  
при условии сохранения уведомления об авторских правах и текста лицензии.

# ZIMBRA DAILY DISABLE INACTIVE ACCOUNTS

**Важно:** Этот скрипт **не является самостоятельным** и работает в связке с другим скриптом (например, `[check_ldap.sh](https://github.com/DonBellozi/zimbra_check_ldap)` или аналогичным), который предварительно формирует файл `/opt/zimbra/accounts_with_date.csv`.  
Без актуального CSV-файла скрипт завершится с ошибкой.

## Назначение

Скрипт предназначен для ежедневного автоматического перевода почтовых ящиков Zimbra в статус `closed` на основании активности учетной записи, дат в поле `Notes` и списка исключений.

Скрипт запускается из-под пользователя `zimbra`, поддерживает режим `dry-run` и безопасен для использования в `cron`.

---

## Входные данные

### 1) CSV-файл учетных записей

Путь к файлу:
`/opt/zimbra/accounts_with_date.csv`

Формат строк CSV (разделитель `;`):

`Email;Дата создания;Статус;Notes;Последний вход;DisplayName`

Пример содержимого:

`ivanov@domain.ru;20190429191214.000Z;active;;20220614184815.765Z;Иванов И.И.`
`petrov@domain.ru;20200101120000.000Z;active;20210613182827.765Z;;`

---

### 2) Файл исключений

Файл исключений создается программой 1С Зарплата и Кадры для предотвращения блокировки электронных ящиков действующих работников

Путь к файлу:
`/opt/zimbra/logs/tmp/actual_email TXT.txt`

Особенности файла исключений:

- первая строка считается заголовком и игнорируется
- допускаются пустые строки
- в одной строке может быть несколько email
- разделители любые (пробелы, запятые и т.п.)
- регистр email не имеет значения

Пример файла исключений:

`email`
`admin@domain.ru`
`, support@domain.ru`

`test@domain.ru`

---

## Логика работы

Скрипт обрабатывает **только** учетные записи со статусом `active`.

Для каждой учетной записи выполняются проверки ниже.

### Учетная запись полностью пропускается (без дальнейших проверок), если:

- email найден в файле исключений
- в поле `Notes` присутствует строка `never_disable`

---

## Обработка даты в поле Notes

Если в поле `Notes` обнаружена дата в любом из форматов:

- `23.10.2024`
- `23,10,2024`
- `23 10 2024`
- `23102024`

Поведение:

- если дата **меньше или равна** текущей дате — учетная запись закрывается
- если дата **больше** текущей даты (дата в будущем) — учетная запись **полностью игнорируется**
  (проверки неактивности не выполняются)

---

## Проверка неактивности (если даты в Notes нет)

- если указан последний вход — учетная запись закрывается, если с момента последнего входа прошло **более 6 месяцев**
- если последний вход отсутствует — учетная запись закрывается, если с даты создания прошло **более 6 месяцев**

---

## Действие над учетной записью

Для закрытия учетной записи используется команда:

`zmprov ma <email> zimbraAccountStatus closed`

---

## Логи

Основной лог:
`/opt/zimbra/logs/zimbra_disable_today.log`

Формат записей:

`email@domain.ru Увольнение 23.10.2024`
`email@domain.ru неактивна с 14.06.2022`

Лог dry-run режима:
`/opt/zimbra/logs/zimbra_disable_today.dryrun.log`

Отладочный лог:
`/opt/zimbra/logs/zimbra_disable_debug.log`

---

## Dry-run режим

Dry-run режим позволяет проверить работу скрипта без изменения статусов учетных записей.

Запуск:

`./zimbra_disable_today.sh --dry-run`
`./zimbra_disable_today.sh -n`

В режиме dry-run:

- команда `zmprov` не выполняется
- все действия логируются с пометкой `DRY-RUN`

---

## Запуск из cron

Пример ежедневного запуска в 19:30 от пользователя `zimbra`:

`crontab -u zimbra -e`

`30 19 * * * /opt/zimbra/scripts/zimbra_disable_today.sh`

Пример запуска в режиме dry-run по субботам:

`30 19 * * 6 /opt/zimbra/scripts/zimbra_disable_today.sh --dry-run`

---

## Требования

- запуск строго от пользователя `zimbra`
- корректный CSV-файл с разделителем `;`
- установлен и доступен `zmprov`
- GNU `date` (Linux)

---

## Статус

- Готов к использованию в production
- Безопасен для cron
- Поддерживает dry-run
- Учитывает бизнес-исключения
